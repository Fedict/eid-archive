#!/bin/bash

set -e

CODE=$(lsb_release -c -s)
DIST=$(lsb_release -i -s)
REL=$(lsb_release -r -s)
DIR=$(mktemp -d)
CONTINUOUSKEY=
RELEASEKEY=f3dedd58

too_old() {
	echo "distribution too old, cannot continue. Please upgrade, or compile from source."
	exit 1
}

case "$CODE" in
	stretch|buster|bionic|focal)
		:
	;;
	*)
		echo -e "WARNING: Unsupported distribution found. Please see the website at\nhttps://eid.belgium.be/en/faq/which-linux-distributions-are-supported#7406\nfor a list of supported distributions."
		case "$DIST" in
			Ubuntu)
				if dpkg --compare-versions 18.04 le $REL
				then
					CODE=bionic
				else
					too_old
				fi
				echo "Found Ubuntu $REL, using $CODE"
			;;
			Debian)
				CODE=stretch
				echo "Found Debian $REL, using $CODE"
			;;
			*)
				CODE=bionic
				echo "Unknown distribution found. Using $CODE as fallback."
			;;
		esac
	;;
esac
sed -e "s/@DIST@/${CODE}/g" /usr/share/beidconnect-archive/beidconnect.list > $DIR/beidconnect.list
ucf $DIR/beidconnect.list /etc/apt/sources.list.d/beidconnect.list

ln -sf /usr/share/beidconnect-archive/keys/$RELEASEKEY.gpg /etc/apt/trusted.gpg.d/beidconnect-archive-released-builds.gpg
if grep -E '^[[:space:]]*deb.*(continuous|candidate)' /etc/apt/sources.list.d/beidconnect.list >/dev/null 2>&1
then
	ln -sf /usr/share/beidconnect-archive/keys/$CONTINUOUSKEY.gpg /etc/apt/trusted.gpg.d/beidconnect-archive-test-builds.gpg
else
	rm -f /etc/apt/trusted.gpg.d/beidconnect-archive-test-builds.gpg
fi

if [ -x /usr/sbin/update-software-center ]; then
	update-software-center --triggered=TRIGGERED
fi

echo -e "Repository enabled, keys installed. Please run \"apt-get update\" followed by\n\"apt-get install beidconnect\" to install the BeIDConnect software."

#DEBHELPER#
